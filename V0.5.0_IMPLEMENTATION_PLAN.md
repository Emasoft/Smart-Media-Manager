# v0.5.0 Implementation Plan: Folder Import Architecture

## Executive Summary

**Goal**: Replace fragile timing-based batch import with robust single-folder import using Photos.app's native folder import capability.

**Problem with v0.4.4**:
- Timing-based delays don't scale across different machine speeds
- Photos.app still gets overwhelmed around 1900 files despite aggressive delays
- Batch import with 50-100 files creates unnecessary complexity
- No reliable way to prevent resource exhaustion

**Solution from import2photos.sh**:
- Import entire staging folder in ONE AppleScript call
- Photos.app handles the import queue natively
- Add unique sequential suffix to EVERY staged file for reconciliation
- Parse returned filenames to determine imported vs skipped
- Zero timing dependencies, zero delays needed

**Impact**: Major architectural change touching ~500 lines across 5+ functions

---

## Architecture Comparison

### OLD Architecture (v0.4.4 and earlier)

```
Flow:
1. gather_media_files() → List[Path]
2. detect_media() → List[MediaFile]
3. move_to_staging() → stages files WITHOUT unique suffix
4. ensure_compatibility() → convert files as needed
5. sanitize_stage_paths() → rename only if unsafe
6. import_into_photos() → BATCH LOOP with delays
   - Split into batches of 50 files
   - AppleScript: import batch1, wait 10s
   - AppleScript: import batch2, wait 10s
   - Every 3 batches: wait 30s (extended pause)
   - On failure: wait 30s (recovery delay)
   - Track failures per-batch
   - Time: ~60 min for 4477 files

Problems:
- Timing calibrated for one machine speed
- Photos queue backs up faster than it drains
- Fails catastrophically at ~1900 files
- Complex batch management logic
- No way to know which specific files were skipped
```

### NEW Architecture (v0.5.0)

```
Flow:
1. gather_media_files() → List[Path]
2. detect_media() → List[MediaFile]
3. move_to_staging_with_suffix() → stages files WITH unique suffix
   - Original: photo.jpg
   - Staged:   photo (1).jpg
   - Original: photo.jpg (duplicate name in subfolder)
   - Staged:   photo (2).jpg
   - Every file gets sequential suffix for unique identification
4. ensure_compatibility() → convert files as needed
5. sanitize_stage_paths() → REMOVED (suffix already makes unique)
6. import_folder_to_photos() → SINGLE folder import
   - AppleScript: import entire staging_dir in ONE call
   - Photos returns list of imported filenames
   - Reconcile returned names against staged files
   - Determine imported vs skipped via filename matching
   - Time: ~15 min for 4477 files (Photos handles natively)

Benefits:
- No timing dependencies whatsoever
- Photos.app manages its own queue
- Works on any machine speed
- Automatic duplicate detection
- Per-file import tracking via filename reconciliation
- Simpler code (remove 200+ lines of batch logic)
```

---

## Detailed Changes by Function

### 1. Remove ALL Timing Constants (cli.py lines 48-58)

**Current code:**
```python
MAX_APPLESCRIPT_ARGS = 50  # Reduced to 50 for more granular batch control
PHOTOS_BATCH_DELAY = int(os.getenv("SMM_BATCH_DELAY", "10"))
PHOTOS_EXTENDED_PAUSE_INTERVAL = 3
PHOTOS_EXTENDED_PAUSE_DURATION = 30
PHOTOS_FAILURE_RECOVERY_DELAY = 30
```

**Action**: DELETE entirely - no longer needed

**Reason**: Single folder import has zero timing dependencies

---

### 2. Update `move_to_staging()` → `move_to_staging_with_suffix()` (cli.py lines 2626-2664)

**Current logic:**
```python
def move_to_staging(media_files: Iterable[MediaFile], staging: Path) -> None:
    for media in media_list:
        stem = media.source.stem
        # Handle Live Photo pairs...
        destination = next_available_name(staging, stem, media.extension)
        shutil.move(str(media.source), str(destination))
        media.stage_path = destination
```

**New logic:**
```python
def move_to_staging_with_suffix(media_files: Iterable[MediaFile], staging: Path) -> None:
    """Stage media files with unique sequential suffix for folder import.

    Every file gets a suffix like " (1)", " (2)", etc. before extension.
    This enables filename reconciliation after Photos import.

    Examples:
        photo.jpg → photo (1).jpg
        photo.jpg (from subfolder) → photo (2).jpg
        video.mov → video (1).mov
    """
    sequence_counter = 1  # Global counter for all files

    for media in media_list:
        stem = media.source.stem

        # Handle Live Photo pairs with consistent naming
        if media.metadata.get("is_live_photo"):
            content_id = media.metadata.get("live_photo_content_id")
            if content_id:
                if content_id in live_photo_stems:
                    stem = live_photo_stems[content_id]
                else:
                    live_photo_stems[content_id] = stem

        # Add unique sequential suffix to EVERY file
        suffix = f" ({sequence_counter})"
        unique_name = f"{stem}{suffix}{media.extension}"
        destination = staging / unique_name

        # Handle collision (very unlikely with global counter)
        collision_counter = 1
        while destination.exists():
            collision_counter += 1
            unique_name = f"{stem} ({sequence_counter}-{collision_counter}){media.extension}"
            destination = staging / unique_name

        shutil.move(str(media.source), str(destination))
        media.stage_path = destination
        sequence_counter += 1

        # Archive originals if processing needed
        if media.requires_processing:
            original_target = next_available_name(originals_dir, stem, media.original_suffix or media.extension)
            shutil.copy2(destination, original_target)
            media.metadata["original_archive"] = str(original_target)
```

**Key changes:**
- Add global `sequence_counter` starting at 1
- Every file gets ` (N)` suffix before extension
- Remove dependency on `next_available_name()` for primary staging
- Keep collision handling as safety net
- Increment counter after each file

---

### 3. Remove `sanitize_stage_paths()` (cli.py lines 2137-2148)

**Current code:**
```python
def sanitize_stage_paths(media_files: list[MediaFile], run_token: str) -> None:
    """Sanitize staged filenames only if they contain unsafe characters..."""
    # Complex logic to detect unsafe names and rename
```

**Action**: DELETE entirely

**Reason**:
- Sequential suffix already makes every filename unique
- No need for separate sanitization pass
- Simpler = better

---

### 4. Replace `import_into_photos()` with `import_folder_to_photos()` (cli.py lines 3392-3580)

**Current code** (~190 lines):
```python
def import_into_photos(media_files: list[MediaFile], stats: RunStatistics) -> tuple[int, list[tuple[MediaFile, str]]]:
    """Import media files into Apple Photos using batched AppleScript calls..."""

    # Complex batching logic
    batches = []
    current_batch = []
    for media in media_files:
        current_batch.append(media)
        if len(current_batch) >= MAX_APPLESCRIPT_ARGS:
            batches.append(current_batch)
            current_batch = []

    # Import with delays
    for batch_num, batch in enumerate(batches, 1):
        # Import batch via AppleScript
        result = run_applescript(...)

        # Base delay
        time.sleep(PHOTOS_BATCH_DELAY)

        # Extended pause every N batches
        if batch_num % PHOTOS_EXTENDED_PAUSE_INTERVAL == 0:
            time.sleep(PHOTOS_EXTENDED_PAUSE_DURATION)

        # Failure recovery delay
        if all_failed:
            time.sleep(PHOTOS_FAILURE_RECOVERY_DELAY)
```

**New code** (~120 lines):
```python
def import_folder_to_photos(
    staging_dir: Path,
    media_files: list[MediaFile],
    album_name: str,
    skip_duplicates: bool = False
) -> tuple[int, int, list[MediaFile]]:
    """Import entire staging folder in a single Photos.app call.

    Uses Photos' native folder import which handles queue management.
    Returns imported filenames and reconciles against staged files.

    Args:
        staging_dir: Path to staging folder containing all media
        media_files: List of MediaFile objects with stage_path set
        album_name: Photos album to import into
        skip_duplicates: If True, skip duplicate checking

    Returns:
        (imported_count, skipped_count, skipped_media_files)
    """

    # Build AppleScript for folder import
    applescript = f'''
on run argv
    if (count of argv) < 3 then return "ERR\\t0\\tMissing arguments"
    set albumName to item 1 of argv
    set skipDup to ((item 2 of argv) is "true")
    set dirPath to item 3 of argv

    script util
        on sanitizeText(srcText)
            set oldTIDs to AppleScript's text item delimiters
            set AppleScript's text item delimiters to {{return, linefeed, tab}}
            set parts to text items of srcText
            set AppleScript's text item delimiters to " "
            set out to parts as text
            set AppleScript's text item delimiters to oldTIDs
            return out
        end sanitizeText
    end script

    try
        set folderAlias to POSIX file (dirPath as text)
    on error errMsg number errNum
        return "ERR\\t" & (errNum as text) & "\\t" & errMsg
    end try

    set outLines to {{}}
    tell application id "com.apple.Photos"
        activate
        try
            if (count of (albums whose name is albumName)) = 0 then
                make new album named albumName
            end if
            set tgtAlbum to first album whose name is albumName

            -- SINGLE folder import call
            set importedItems to import folderAlias skip check duplicates skipDup

            if (count of importedItems) > 0 then
                add importedItems to tgtAlbum
            end if

            -- Return filenames of imported items
            repeat with mi in importedItems
                try
                    set fn to filename of mi
                    set fn2 to util's sanitizeText(fn)
                    set end of outLines to "FN\\t" & fn2
                end try
            end repeat
        on error errMsg number errNum
            return "ERR\\t" & (errNum as text) & "\\t" & errMsg
        end try
    end tell

    set oldTIDs to AppleScript's text item delimiters
    set AppleScript's text item delimiters to linefeed
    set outText to outLines as text
    set AppleScript's text item delimiters to oldTIDs
    return outText
end run
'''

    # Execute AppleScript
    LOG.info("Importing staging folder into Photos...")
    result = subprocess.run(
        ["osascript", "-", album_name, str(skip_duplicates).lower(), str(staging_dir)],
        input=applescript,
        capture_output=True,
        text=True,
        timeout=1800  # 30 min max for large imports
    )

    output = result.stdout.strip()

    # Check for fatal error
    if output.startswith("ERR\t"):
        parts = output.split("\t")
        err_code = parts[1] if len(parts) > 1 else "0"
        err_msg = parts[2] if len(parts) > 2 else "Unknown error"
        raise RuntimeError(f"Photos import failed [{err_code}]: {err_msg}")

    # Parse imported filenames
    imported_names = []
    for line in output.split("\n"):
        if line.startswith("FN\t"):
            filename = line[3:]  # Remove "FN\t" prefix
            imported_names.append(filename)

    # Reconcile: match imported names against staged files
    # Build multiset of imported names (handle duplicates)
    imported_multiset = {}
    for name in imported_names:
        imported_multiset[name] = imported_multiset.get(name, 0) + 1

    # Match staged files against imported multiset
    imported_media = []
    skipped_media = []

    for media in media_files:
        basename = media.stage_path.name
        if basename in imported_multiset and imported_multiset[basename] > 0:
            imported_media.append(media)
            imported_multiset[basename] -= 1
        else:
            skipped_media.append(media)

    imported_count = len(imported_media)
    skipped_count = len(skipped_media)

    LOG.info("Import complete: %d imported, %d skipped", imported_count, skipped_count)

    return imported_count, skipped_count, skipped_media
```

**Key changes:**
- Single AppleScript call for entire folder
- Use `import folderAlias skip check duplicates skipDup`
- Parse returned filenames (format: `FN\t<filename>`)
- Reconcile filenames using multiset matching
- Return skipped files for logging
- Remove ALL timing/delay logic
- Remove batch splitting logic
- Remove progress bar between batches

---

### 5. Update `run()` main function (cli.py lines 3820-4100)

**Current flow:**
```python
def run() -> None:
    # ... setup ...

    # Stage files
    move_to_staging(detected, staging)

    # Process for compatibility
    ensure_compatibility(detected, staging, stats)

    # Sanitize filenames
    sanitize_stage_paths(detected, run_token)

    # Import with batching + delays
    imported_count, failures = import_into_photos(detected, stats)

    # Handle failures
    if failures:
        # ... safe fallback logic ...
```

**New flow:**
```python
def run() -> None:
    # ... setup ...

    # Stage files with unique sequential suffix
    move_to_staging_with_suffix(detected, staging)

    # Process for compatibility
    ensure_compatibility(detected, staging, stats)

    # Import entire folder in single call (NO sanitization needed)
    imported_count, skipped_count, skipped_media = import_folder_to_photos(
        staging_dir=staging,
        media_files=detected,
        album_name=args.album,
        skip_duplicates=not args.check_duplicates
    )

    # Log skipped files
    if skipped_media:
        skip_log = log_dir / f"smm_skipped_files_{run_ts}.log"
        with open(skip_log, "w") as f:
            f.write(f"# Skipped files — {len(skipped_media)} items — {run_ts}\n")
            for media in skipped_media:
                reason = "Duplicate or rejected by Photos"
                f.write(f"{media.source}\t{reason}\n")

    # Update stats
    stats.imported_count = imported_count
    stats.skipped_count = skipped_count
```

**Key changes:**
- Call `move_to_staging_with_suffix()` instead of `move_to_staging()`
- Remove `sanitize_stage_paths()` call
- Replace `import_into_photos()` with `import_folder_to_photos()`
- Handle skipped files directly (no "failures" concept)
- Simpler error handling (no batch failure recovery)

---

### 6. Remove Safe Fallback Logic (cli.py lines 2212-2226)

**Current code:**
```python
def enforce_safe_fallback(media_files: list[MediaFile]) -> None:
    """Force all media to maximally compatible formats when Photos rejects batch..."""
```

**Action**: DELETE or SIMPLIFY

**Reason**:
- With folder import, Photos doesn't "reject batches"
- It either imports individual files or skips them
- If Photos skips a file, it's likely a duplicate or truly incompatible
- Safe fallback was a workaround for batch failures

**Alternative**: Keep simplified version that operates on skipped files if user wants to retry:
```python
def convert_skipped_to_safe_formats(skipped_media: list[MediaFile]) -> None:
    """Convert skipped files to maximally safe formats for retry.

    Only call this if user explicitly wants to force import skipped files.
    """
    # Convert images to JPEG
    # Convert videos to H.264 MP4
    # Re-import just these files
```

---

### 7. Update Logging and Statistics

**Changes needed:**

1. **Remove batch-related stats:**
```python
# DELETE these from RunStatistics:
batch_count: int = 0
batch_failures: int = 0
```

2. **Add reconciliation stats:**
```python
# ADD these to RunStatistics:
imported_count: int = 0
skipped_count: int = 0  # Photos skipped (duplicates or incompatible)
```

3. **Update log messages:**
```python
# OLD:
LOG.info("Batch %d/%d: %d imported, %d failed", batch_num, num_batches, ...)

# NEW:
LOG.info("Folder import complete: %d imported, %d skipped", imported_count, skipped_count)
```

---

### 8. Update CLI Arguments (cli.py lines 1680-1740)

**Add new argument:**
```python
parser.add_argument(
    "--check-duplicates",
    action="store_true",
    default=False,
    help="Check for duplicates before importing (slower but safer). Default: skip duplicate check."
)
```

**Reason**: Match import2photos.sh behavior - let user control duplicate checking

---

### 9. Update Documentation

**Files to update:**

1. **COOLDOWN_FIX.md**:
   - Mark as OBSOLETE (timing approach deprecated)
   - Add note: "See V0.5.0_IMPLEMENTATION_PLAN.md for new architecture"

2. **CLAUDE.md**:
   - Update architecture section
   - Remove batch import references
   - Add folder import explanation
   - Update expected timeline (60 min → 15 min for 4477 files)

3. **README.md** (if exists):
   - Update feature list
   - Remove mentions of batch delays
   - Add folder import as key feature

---

## File-by-File Checklist

### smart_media_manager/cli.py

- [ ] **Lines 48-58**: DELETE all timing constants
  - [ ] Remove `MAX_APPLESCRIPT_ARGS`
  - [ ] Remove `PHOTOS_BATCH_DELAY`
  - [ ] Remove `PHOTOS_EXTENDED_PAUSE_INTERVAL`
  - [ ] Remove `PHOTOS_EXTENDED_PAUSE_DURATION`
  - [ ] Remove `PHOTOS_FAILURE_RECOVERY_DELAY`

- [ ] **Lines 2626-2664**: REPLACE `move_to_staging()` with `move_to_staging_with_suffix()`
  - [ ] Add global sequence counter starting at 1
  - [ ] Add ` (N)` suffix to every filename before extension
  - [ ] Handle collision with `-N` sub-suffix
  - [ ] Increment counter for each file
  - [ ] Preserve Live Photo pair handling
  - [ ] Keep ORIGINALS archiving logic

- [ ] **Lines 2137-2148**: DELETE `sanitize_stage_paths()` entirely

- [ ] **Lines 2212-2226**: SIMPLIFY or DELETE `enforce_safe_fallback()`
  - [ ] Option 1: Delete entirely
  - [ ] Option 2: Simplify to only handle user-requested retry of skipped files

- [ ] **Lines 3392-3580**: REPLACE `import_into_photos()` with `import_folder_to_photos()`
  - [ ] Write new AppleScript for folder import
  - [ ] Remove all batch splitting logic (~50 lines)
  - [ ] Remove all timing/delay logic (~30 lines)
  - [ ] Add filename reconciliation logic (~40 lines)
  - [ ] Return (imported_count, skipped_count, skipped_media) instead of (count, failures)
  - [ ] Handle AppleScript errors with clear messages

- [ ] **Lines 3820-4100**: UPDATE `run()` main function
  - [ ] Call `move_to_staging_with_suffix()` instead of `move_to_staging()`
  - [ ] Remove `sanitize_stage_paths()` call
  - [ ] Replace `import_into_photos()` with `import_folder_to_photos()`
  - [ ] Update error handling (no batch failures)
  - [ ] Update skip log format (no "failures", just "skipped")
  - [ ] Update statistics tracking

- [ ] **Lines 1680-1740**: ADD CLI argument
  - [ ] Add `--check-duplicates` flag

- [ ] **Lines 300-400**: UPDATE `RunStatistics` dataclass
  - [ ] Remove `batch_count`, `batch_failures`
  - [ ] Add `skipped_count`

### Documentation Files

- [ ] **COOLDOWN_FIX.md**:
  - [ ] Add "OBSOLETE" header
  - [ ] Add migration note to v0.5.0

- [ ] **CLAUDE.md**:
  - [ ] Update architecture section
  - [ ] Remove batch import references
  - [ ] Add folder import documentation
  - [ ] Update expected timelines

- [ ] **README.md**:
  - [ ] Update feature descriptions
  - [ ] Remove timing calibration mentions

- [ ] **V0.5.0_IMPLEMENTATION_PLAN.md** (this file):
  - [ ] Keep for historical reference

### Testing Files

- [ ] **tests/test_photos_pipeline.py**:
  - [ ] Update mocks for new function signatures
  - [ ] Remove batch-related tests
  - [ ] Add folder import tests
  - [ ] Add filename reconciliation tests

---

## Implementation TODO List

### Phase 1: Preparation (30 min)
- [ ] 1.1: Create new branch: `git checkout -b feature/folder-import-v0.5.0`
- [ ] 1.2: Read current `move_to_staging()` implementation fully
- [ ] 1.3: Read current `import_into_photos()` implementation fully
- [ ] 1.4: Study import2photos.sh AppleScript section (lines 297-349)
- [ ] 1.5: Verify understanding of filename reconciliation logic (lines 384-442)

### Phase 2: Remove Old Code (20 min)
- [ ] 2.1: Delete timing constants (lines 48-58)
- [ ] 2.2: Delete `sanitize_stage_paths()` function
- [ ] 2.3: Delete or simplify `enforce_safe_fallback()`
- [ ] 2.4: Delete old `import_into_photos()` function entirely
- [ ] 2.5: Update `RunStatistics` dataclass (remove batch fields)

### Phase 3: Implement New Functions (90 min)
- [ ] 3.1: Implement `move_to_staging_with_suffix()`
  - [ ] 3.1a: Add sequence counter initialization
  - [ ] 3.1b: Add suffix formatting: ` (N)`
  - [ ] 3.1c: Handle collisions with `-N` sub-suffix
  - [ ] 3.1d: Preserve Live Photo pair logic
  - [ ] 3.1e: Keep ORIGINALS archiving
  - [ ] 3.1f: Test with sample files

- [ ] 3.2: Implement `import_folder_to_photos()`
  - [ ] 3.2a: Write AppleScript for folder import
  - [ ] 3.2b: Add subprocess call with 30min timeout
  - [ ] 3.2c: Parse AppleScript output (FN\t<filename> format)
  - [ ] 3.2d: Implement filename reconciliation with multiset
  - [ ] 3.2e: Return (imported_count, skipped_count, skipped_media)
  - [ ] 3.2f: Add comprehensive error handling

### Phase 4: Update Main Flow (30 min)
- [ ] 4.1: Update `run()` function
  - [ ] 4.1a: Replace `move_to_staging()` call
  - [ ] 4.1b: Remove `sanitize_stage_paths()` call
  - [ ] 4.1c: Replace `import_into_photos()` call
  - [ ] 4.1d: Update skip log writing
  - [ ] 4.1e: Update statistics tracking

- [ ] 4.2: Add `--check-duplicates` CLI argument

### Phase 5: Testing (60 min)
- [ ] 5.1: Unit tests
  - [ ] 5.1a: Test `move_to_staging_with_suffix()` with various inputs
  - [ ] 5.1b: Test filename collision handling
  - [ ] 5.1c: Test Live Photo pair suffix consistency
  - [ ] 5.1d: Mock test `import_folder_to_photos()` AppleScript

- [ ] 5.2: Integration tests
  - [ ] 5.2a: Create small test dataset (10 files)
  - [ ] 5.2b: Run full pipeline with test data
  - [ ] 5.2c: Verify all files get unique suffixes
  - [ ] 5.2d: Verify folder import works
  - [ ] 5.2e: Verify filename reconciliation works

- [ ] 5.3: Real-world test
  - [ ] 5.3a: Test with 100 real media files
  - [ ] 5.3b: Test with duplicates (verify skip logic)
  - [ ] 5.3c: Test with incompatible files (verify skip logic)
  - [ ] 5.3d: Verify Photos.app doesn't get overwhelmed
  - [ ] 5.3e: Measure import time vs v0.4.4

### Phase 6: Documentation (30 min)
- [ ] 6.1: Mark COOLDOWN_FIX.md as obsolete
- [ ] 6.2: Update CLAUDE.md architecture section
- [ ] 6.3: Update README.md if it exists
- [ ] 6.4: Add docstrings to new functions
- [ ] 6.5: Add inline comments explaining reconciliation logic

### Phase 7: Finalization (20 min)
- [ ] 7.1: Bump version to 0.5.0 in pyproject.toml
- [ ] 7.2: Update __version__ in __init__.py if needed
- [ ] 7.3: Run `uv build` and verify package contents
- [ ] 7.4: Run `uv tool install .` and test installed version
- [ ] 7.5: Create git commit with comprehensive message
- [ ] 7.6: Merge to main: `git checkout main && git merge feature/folder-import-v0.5.0`
- [ ] 7.7: Tag release: `git tag v0.5.0 -m "Folder import architecture"`

---

## Testing Plan

### Test Cases

#### 1. Sequential Suffix Test
```python
# Input:
files = ["photo.jpg", "photo.jpg", "video.mov", "photo.jpg"]

# Expected staged names:
["photo (1).jpg", "photo (2).jpg", "video (1).mov", "photo (3).jpg"]
```

#### 2. Live Photo Pair Test
```python
# Input (paired):
files = [
    "IMG_1234.HEIC" (content_id: "ABC123", is_live_photo: True),
    "IMG_1234.MOV" (content_id: "ABC123", is_live_photo: True)
]

# Expected staged names (same stem):
["IMG_1234 (1).HEIC", "IMG_1234 (2).MOV"]
```

#### 3. Collision Test
```python
# Input (staged file already exists):
existing = ["photo (1).jpg"]
new_file = "photo.jpg"

# Expected:
"photo (1-2).jpg"  # Sub-suffix added
```

#### 4. Folder Import Test
```bash
# Setup:
staging/
  photo (1).jpg
  photo (2).jpg
  video (1).mov
  photo (3).jpg

# AppleScript returns:
FN\tphoto (1).jpg
FN\tphoto (3).jpg
FN\tvideo (1).mov

# Expected reconciliation:
imported = ["photo (1).jpg", "photo (3).jpg", "video (1).mov"]
skipped = ["photo (2).jpg"]  # Duplicate or rejected
```

#### 5. Large Import Test
```bash
# Setup: 4477 files across subdirectories
# Run: smart-media-manager --path /test/media --recursive
# Expected:
#   - All files get unique sequential suffix
#   - Single folder import completes in <20 min
#   - No Photos.app resource exhaustion
#   - Accurate imported/skipped counts
```

---

## Risk Assessment

### High Risk Items

1. **AppleScript compatibility**
   - Risk: Folder import API might differ across macOS versions
   - Mitigation: Test on multiple macOS versions (Ventura, Sonoma)
   - Fallback: Keep v0.4.4 as stable branch

2. **Filename reconciliation accuracy**
   - Risk: Multiset matching might miss edge cases
   - Mitigation: Comprehensive unit tests with duplicates
   - Fallback: Log ALL returned filenames and staged files for debugging

3. **Photos.app timeout on huge imports**
   - Risk: 10,000+ files might exceed 30min timeout
   - Mitigation: Make timeout configurable via environment variable
   - Fallback: Split into multiple runs if needed

### Medium Risk Items

1. **Live Photo pair suffix consistency**
   - Risk: Paired files might get different stems
   - Mitigation: Preserve existing pair tracking logic
   - Test thoroughly with real Live Photos

2. **Compatibility processing with new naming**
   - Risk: Conversion functions might not handle ` (N)` suffix
   - Mitigation: Test conversion pipeline with suffixed names
   - Verify ORIGINALS archiving works

### Low Risk Items

1. **CLI argument changes**
   - Risk: Breaking change for existing users
   - Mitigation: Document in release notes
   - Add `--check-duplicates` as opt-in

2. **Log format changes**
   - Risk: Parsing scripts might break
   - Mitigation: Document new format
   - Keep backward-compatible field names where possible

---

## Success Criteria

### Must Have
- ✅ Single folder import works with 100+ files
- ✅ Filename reconciliation correctly identifies imported vs skipped
- ✅ Zero timing dependencies
- ✅ Works on Photos.app (macOS Ventura and later)
- ✅ Handles duplicates correctly
- ✅ No Photos.app resource exhaustion at any scale
- ✅ All existing format detection/conversion logic preserved

### Should Have
- ✅ Import time <20 min for 4500 files (vs 60 min in v0.4.4)
- ✅ Unit test coverage >80% for new functions
- ✅ Integration test with real Photos.app
- ✅ Clear documentation of new architecture
- ✅ Migration guide from v0.4.4

### Nice to Have
- ✅ Configurable timeout via environment variable
- ✅ Progress indication during long imports
- ✅ Dry-run mode to preview import without executing
- ✅ Detailed reconciliation report (which files skipped and why)

---

## Rollback Plan

If v0.5.0 has critical issues:

1. **Keep v0.4.4 tag**: `git tag v0.4.4-stable`
2. **Branch protection**: `feature/folder-import-v0.5.0` stays separate
3. **Quick rollback**: `git revert <commit>` or `git checkout v0.4.4-stable`
4. **Communicate clearly**: Document known issues in GitHub releases

---

## Estimated Time

- **Phase 1 (Prep)**: 30 min
- **Phase 2 (Remove)**: 20 min
- **Phase 3 (Implement)**: 90 min
- **Phase 4 (Update)**: 30 min
- **Phase 5 (Test)**: 60 min
- **Phase 6 (Docs)**: 30 min
- **Phase 7 (Finalize)**: 20 min

**Total**: ~4.5 hours of focused implementation time

---

## Next Steps

1. **Read this plan thoroughly** in next conversation
2. **Clarify any questions** before starting
3. **Execute phase by phase** with checkpoints
4. **Test incrementally** after each phase
5. **Commit frequently** (after each major change)
6. **Document issues** as they arise

---

## References

- **import2photos.sh**: Lines 240-280 (staging with suffix), Lines 297-349 (folder import), Lines 384-442 (reconciliation)
- **Current cli.py**: Lines 2626-2664 (move_to_staging), Lines 3392-3580 (import_into_photos)
- **Apple Photos AppleScript reference**: `import` command with `skip check duplicates` parameter

---

**Status**: Ready for implementation in next conversation
**Last Updated**: 2025-10-30
**Author**: Claude (based on user requirements and import2photos.sh analysis)
