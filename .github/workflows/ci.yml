name: CI

# Uses samples/test_set.yaml (public test set) for CI testing
# For local comprehensive testing: pytest --test-set=samples_dev/test_set.yaml

on:
  # Trigger on pushes to main
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'docs_dev/**'
      - 'scripts_dev/**'
      - 'samples_dev/**'
      - 'tests/samples/**'
      - 'tests/fixtures/**'
      - 'LICENSE'

  # Trigger on pull requests to main
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'docs_dev/**'
      - 'scripts_dev/**'
      - 'samples_dev/**'
      - 'tests/samples/**'
      - 'tests/fixtures/**'
      - 'LICENSE'

  # Allow manual triggering from GitHub UI or CLI
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - tests-only
          - lint-only
          - quick

  # Trigger on issue comments (for Claude Code commands)
  issue_comment:
    types: [created]

jobs:
  # Check if we should skip based on workflow dispatch input
  should-run:
    name: Check Run Configuration
    runs-on: ubuntu-latest
    outputs:
      run-tests: ${{ steps.check.outputs.run-tests }}
      run-lint: ${{ steps.check.outputs.run-lint }}
      run-typecheck: ${{ steps.check.outputs.run-typecheck }}
      run-security: ${{ steps.check.outputs.run-security }}
      run-build: ${{ steps.check.outputs.run-build }}
    steps:
      - name: Determine what to run
        id: check
        run: |
          RUN_TYPE="${{ github.event.inputs.run_type || 'full' }}"

          if [ "$RUN_TYPE" = "tests-only" ]; then
            echo "run-tests=true" >> $GITHUB_OUTPUT
            echo "run-lint=false" >> $GITHUB_OUTPUT
            echo "run-typecheck=false" >> $GITHUB_OUTPUT
            echo "run-security=false" >> $GITHUB_OUTPUT
            echo "run-build=false" >> $GITHUB_OUTPUT
          elif [ "$RUN_TYPE" = "lint-only" ]; then
            echo "run-tests=false" >> $GITHUB_OUTPUT
            echo "run-lint=true" >> $GITHUB_OUTPUT
            echo "run-typecheck=true" >> $GITHUB_OUTPUT
            echo "run-security=false" >> $GITHUB_OUTPUT
            echo "run-build=false" >> $GITHUB_OUTPUT
          elif [ "$RUN_TYPE" = "quick" ]; then
            echo "run-tests=true" >> $GITHUB_OUTPUT
            echo "run-lint=true" >> $GITHUB_OUTPUT
            echo "run-typecheck=false" >> $GITHUB_OUTPUT
            echo "run-security=false" >> $GITHUB_OUTPUT
            echo "run-build=false" >> $GITHUB_OUTPUT
          else
            # full run
            echo "run-tests=true" >> $GITHUB_OUTPUT
            echo "run-lint=true" >> $GITHUB_OUTPUT
            echo "run-typecheck=true" >> $GITHUB_OUTPUT
            echo "run-security=true" >> $GITHUB_OUTPUT
            echo "run-build=true" >> $GITHUB_OUTPUT
          fi

  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: macos-latest
    needs: should-run
    if: needs.should-run.outputs.run-tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install dependencies
      run: uv sync

    - name: Verify test samples exist
      run: |
        echo "Checking samples/test_set.yaml..."
        test -f samples/test_set.yaml || (echo "ERROR: samples/test_set.yaml not found" && exit 1)
        echo "Checking sample files..."
        test -f samples/images/test_pattern.jpg || (echo "ERROR: test image not found" && exit 1)
        test -f samples/videos/test_video.mp4 || (echo "ERROR: test video not found" && exit 1)
        echo "All test samples verified!"

    - name: Run minimal CI tests
      run: |
        uv run pytest -m minimal -v --tb=short --color=yes 2>&1 | tee pytest-output.txt

    - name: Generate test report
      if: always()
      run: |
        echo "## Test Results for Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat pytest-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results-${{ matrix.python-version }}
        path: pytest-output.txt
        retention-days: 30

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    needs: should-run
    if: needs.should-run.outputs.run-lint == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Run ruff check
      run: |
        echo "## Ruff Check Results" >> $GITHUB_STEP_SUMMARY
        uv run ruff check smart_media_manager/ tests/ --output-format=github 2>&1 | tee ruff-check.txt
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat ruff-check.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Check formatting
      run: |
        echo "## Ruff Format Check" >> $GITHUB_STEP_SUMMARY
        uv run ruff format --check --line-length=320 smart_media_manager/ tests/ 2>&1 | tee ruff-format.txt
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat ruff-format.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: |
          ruff-check.txt
          ruff-format.txt
        retention-days: 30

  type-check:
    name: Type Check with mypy
    runs-on: ubuntu-latest
    needs: should-run
    if: needs.should-run.outputs.run-typecheck == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Run mypy
      run: |
        echo "## MyPy Type Check Results" >> $GITHUB_STEP_SUMMARY
        uv run mypy smart_media_manager/ --pretty --show-error-codes 2>&1 | tee mypy-output.txt
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat mypy-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload mypy results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mypy-results
        path: mypy-output.txt
        retention-days: 30

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: should-run
    if: needs.should-run.outputs.run-security == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Run gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Security scan summary
      if: always()
      run: |
        echo "## Security Scan Completed" >> $GITHUB_STEP_SUMMARY
        echo "Check the Actions tab for detailed results" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [should-run, test, lint]
    if: |
      always() &&
      needs.should-run.outputs.run-build == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Build package
      run: |
        uv build
        ls -lh dist/

    - name: Check build artifacts
      run: |
        echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -lh dist/ >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        retention-days: 30

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [should-run, test, lint, type-check, security, build]
    if: always()

    steps:
    - name: Generate workflow summary
      run: |
        echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
        echo "- Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Type Check: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All artifacts are available in the Actions tab for 30 days." >> $GITHUB_STEP_SUMMARY
